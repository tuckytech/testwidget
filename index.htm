<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Widget Page</title>

  <!-- Overlay & Iframe CSS -->
  <style>
    /* Creates a dark overlay behind the iframe when body has .overlay-active */
    body.overlay-active::before {
      content: "";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9999999999; /* behind the iframe */
    }

    /* The iframe starts at small size; we put it on top of the overlay */
    #widgetpopup {
      position: relative;
      z-index: 10000000000; 
      margin: 0 auto;
      display: block;
    }
  </style>

  <script>
    // Listen for messages from the iframe
    window.addEventListener('message', (event) => {
      // Ensure there's a valid data structure
      if (!event.data || !event.data.WorkflowAPICall) return;

      // Parse the JSON payload from Bubble
      const eventDataParsed = JSON.parse(event.data.WorkflowAPICall);
      const widgetPopup = document.getElementById("widgetpopup");

      switch (eventDataParsed.endpoint) {
        case "open-widgetpopup":
          console.log("Entered case 'open-widgetpopup'");
          // Add the overlay class to the BODY
          document.body.classList.add('overlay-active');

          // Make the iframe fill the screen & be scrollable
          widgetPopup.style.height = "100%";
          widgetPopup.style.width = "100%";
          widgetPopup.style.position = "fixed";
          widgetPopup.style.left = "50%";
          widgetPopup.style.top = "50%";
          widgetPopup.style.transform = "translate(-50%, -50%)";
          widgetPopup.style.zIndex = "10000000000";
          widgetPopup.setAttribute("scrolling", "auto"); 
          break;

        case "close-popup":
          console.log("Entered case 'close-popup'");
          // Remove the overlay
          document.body.classList.remove('overlay-active');

          // Restore the iframeâ€™s smaller size
          widgetPopup.style.height = "476px";
          widgetPopup.style.width = "400px";
          widgetPopup.style.position = "relative";
          widgetPopup.style.left = "inherit";
          widgetPopup.style.top = "inherit";
          widgetPopup.style.transform = "none";
          widgetPopup.style.zIndex = "1";
          widgetPopup.setAttribute("scrolling", "no");
          break;
      }
    }, false);
  </script>
</head>

<body>
  <script type="text/javascript">
    // Dynamically build the iframe src using the parent's URL
    // (If cross-domain issues occur, replace parent.document.URL with window.location.href)
    let url;
    try {
      url = parent.document.URL;
    } catch (e) {
      url = window.location.href;
    }

    // Output the <iframe> that references your Bubble widget
    document.write(
      '<iframe id="widgetpopup" ' +
        'src="https://greenthechain.com/version-test/widget2/1730179417198x962409578276585500?websiteSourceURL=' + url + '" ' +
        'width="400" ' +
        'height="476" ' +
        'frameborder="0" ' +
        'scrolling="no">' +
      '</iframe>'
    );
  </script>
</body>
</html>
