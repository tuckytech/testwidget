<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Widget Page</title>

  <style>
    /* 1) Create a dark overlay behind the iframe via body.overlay-active::before. */
    body.overlay-active::before {
      content: "";
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9999999998; /* The iframe goes above this. */
    }

    /* 2) Style for the iframe in normal (closed) state. */
    #widgetpopup {
      margin: 0 auto;
      display: block;
      position: relative;
      width: 400px;
      height: 476px;
      z-index: 9999999999; /* Enough to be on top of the overlay. */
    }
  </style>

  <script>
    // Listen for messages from the iframe
    window.addEventListener('message', (event) => {
      // Check if there's a valid WorkflowAPICall
      if (!event.data || !event.data.WorkflowAPICall) return;

      // Parse the JSON payload from Bubble
      const eventDataParsed = JSON.parse(event.data.WorkflowAPICall);
      const widgetPopup = document.getElementById("widgetpopup");

      switch (eventDataParsed.endpoint) {
        case "open-widgetpopup":
          console.log("Entered case 'open-widgetpopup'");
          // 1) Add the overlay behind the iframe
          document.body.classList.add("overlay-active");

          // 2) Make the iframe fill the screen and allow scrolling
          widgetPopup.style.position = "fixed";
          widgetPopup.style.top = "50%";
          widgetPopup.style.left = "50%";
          widgetPopup.style.transform = "translate(-50%, -50%)";
          widgetPopup.style.width = "100%";
          widgetPopup.style.height = "100%";
          widgetPopup.style.zIndex = "9999999999";
          widgetPopup.setAttribute("scrolling", "auto");
          break;

        case "close-popup":
          console.log("Entered case 'close-popup'");
          // 1) Remove the dark overlay
          document.body.classList.remove("overlay-active");

          // 2) Restore the iframe to original size
          widgetPopup.style.position = "relative";
          widgetPopup.style.top = "inherit";
          widgetPopup.style.left = "inherit";
          widgetPopup.style.transform = "none";
          widgetPopup.style.width = "400px";
          widgetPopup.style.height = "476px";
          widgetPopup.style.zIndex = "9999999999";
          widgetPopup.setAttribute("scrolling", "no");
          break;
      }
    }, false);
  </script>
</head>

<body>
  <!-- The only thing we inject into the <body> is the <iframe> itself. -->
  <script type="text/javascript">
    // Safely get the parent URL (in case cross-domain blocks parent.document.URL)
    let url;
    try {
      url = parent.document.URL;
    } catch (e) {
      url = window.location.href;
    }

    // Render the Bubble widget's iframe
    document.write(
      '<iframe id="widgetpopup" ' +
        'src="https://greenthechain.com/version-test/widget2/1730179417198x962409578276585500?websiteSourceURL=' + url + '" ' +
        'width="400" ' +
        'height="476" ' +
        'frameborder="0" ' +
        'scrolling="no">' +
      '</iframe>'
    );
  </script>
</body>
</html>
