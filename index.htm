<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Widget Page</title>
  <script>
    // Listen for messages from the iframe
    window.addEventListener('message', (event) => {
      // Ensure there's a valid data structure
      if (!event.data || !event.data.WorkflowAPICall) return;

      // Parse the JSON payload from Bubble
      const eventDataParsed = JSON.parse(event.data.WorkflowAPICall);

      // Get references to the overlay and the iframe
      const overlay = document.getElementById("overlay");
      const widgetPopup = document.getElementById("widgetpopup");

      switch (eventDataParsed.endpoint) {
        case "open-widgetpopup":
          console.log("Entered case 'open-widgetpopup'");

          // Show the overlay (dims background)
          overlay.style.display = "block";

          // Make the iframe fill the screen & be scrollable
          widgetPopup.style.height = "100%";
          widgetPopup.style.width = "100%";
          widgetPopup.style.position = "fixed";
          widgetPopup.style.left = "50%";
          widgetPopup.style.top = "50%";
          widgetPopup.style.transform = "translate(-50%, -50%)";
          widgetPopup.style.zIndex = "9999999999999999";
          widgetPopup.setAttribute("scrolling", "auto"); 
          break;

        case "close-popup":
          console.log("Entered case 'close-popup'");

          // Hide the overlay
          overlay.style.display = "none";

          // Restore the iframeâ€™s smaller size
          widgetPopup.style.height = "476px";
          widgetPopup.style.width = "400px";
          widgetPopup.style.position = "relative";
          widgetPopup.style.left = "inherit";
          widgetPopup.style.top = "inherit";
          widgetPopup.style.transform = "none";
          widgetPopup.style.zIndex = "1";
          widgetPopup.setAttribute("scrolling", "no");
          break;
      }
    }, false);
  </script>

  <style>
    /* The overlay that dims everything behind the iframe */
    #overlay {
      display: none; /* shown when "open-widgetpopup" is triggered */
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4); 
      z-index: 9999999999999998; /* behind the iframe but above the page */
    }

    /* We start the iframe at a small size (like original) */
    #widgetpopup {
      margin: 0 auto;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Overlay that darkens the page, with the iframe inside it -->
  <div id="overlay">
    <!-- The Bubble widget iframe -->
    <iframe
      id="widgetpopup"
      src=""
      width="400"
      height="476"
      frameborder="0"
      scrolling="no"
    ></iframe>
  </div>

  <script type="text/javascript">
    // Safely build the iframe src. If parent.document.URL is inaccessible, use window.location.href
    let parentUrl;
    try {
      parentUrl = parent.document.URL; // Can fail if cross-domain or file://
    } catch (err) {
      console.warn("Could not access parent.document.URL. Using window.location.href instead.");
      parentUrl = window.location.href;
    }

    // Inject the parent's (or fallback) URL into the iframe's src
    document.getElementById("widgetpopup").src =
      "https://greenthechain.com/version-test/widget2/1730179417198x962409578276585500?websiteSourceURL=" + parentUrl;
  </script>
</body>
</html>
